USE pharmacy_shop;

-- 1. T·∫Øt ki·ªÉm tra kh√≥a ngo·∫°i
SET FOREIGN_KEY_CHECKS = 0;

-- 2. X√≥a b·∫£ng c≈©
DROP TABLE IF EXISTS import_items;
DROP TABLE IF EXISTS order_items;
DROP TABLE IF EXISTS import_batches;
DROP TABLE IF EXISTS orders;
DROP TABLE IF EXISTS products;
DROP TABLE IF EXISTS customers;
DROP TABLE IF EXISTS users;

-- 3. B·∫£ng kh√°ch h√†ng
CREATE TABLE customers (
  id INT NOT NULL AUTO_INCREMENT,
  ma_kh VARCHAR(20) NOT NULL,
  ho_ten VARCHAR(100) NOT NULL,
  dia_chi TEXT,
  dien_thoai VARCHAR(15),
  email VARCHAR(100),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY (ma_kh),
  KEY idx_phone (dien_thoai),
  KEY idx_name (ho_ten)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 4. B·∫£ng s·∫£n ph·∫©m
CREATE TABLE products (
  id INT NOT NULL AUTO_INCREMENT,
  ma_sp VARCHAR(20) NOT NULL,
  ten_sp VARCHAR(255) NOT NULL,
  gia_ban DECIMAL(12,0) NOT NULL,
  don_vi VARCHAR(20) DEFAULT 'V·ªâ',
  so_luong_ton INT DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY (ma_sp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 5. B·∫£ng ƒë∆°n h√†ng
CREATE TABLE orders (
  id INT NOT NULL AUTO_INCREMENT,
  ma_don VARCHAR(20) NOT NULL,
  customer_id INT,
  tong_tien DECIMAL(15,2) DEFAULT 0,
  ngay_mua DATETIME DEFAULT CURRENT_TIMESTAMP,
  trang_thai ENUM('Ch·ªù giao','ƒê√£ giao','H·ªßy') DEFAULT 'Ch·ªù giao',
  PRIMARY KEY (id),
  UNIQUE KEY (ma_don),
  KEY (customer_id),
  CONSTRAINT fk_order_customer FOREIGN KEY (customer_id)
      REFERENCES customers(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 6. B·∫£ng phi·∫øu nh·∫≠p
CREATE TABLE import_batches (
  id INT NOT NULL AUTO_INCREMENT,
  ma_phieu VARCHAR(20) NOT NULL,
  ngay_nhap DATE NOT NULL,
  nha_cung_cap VARCHAR(255),
  tong_tien DECIMAL(12,0) DEFAULT 0,
  ghi_chu TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY (ma_phieu)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 7. B·∫£ng chi ti·∫øt phi·∫øu nh·∫≠p
CREATE TABLE import_items (
  id INT NOT NULL AUTO_INCREMENT,
  import_batch_id INT,
  product_id INT,
  so_luong INT NOT NULL,
  gia_nhap DECIMAL(12,0) NOT NULL,
  PRIMARY KEY (id),
  KEY (import_batch_id),
  KEY (product_id),
  CONSTRAINT fk_import_batch FOREIGN KEY (import_batch_id)
      REFERENCES import_batches(id) ON DELETE CASCADE,
  CONSTRAINT fk_import_product FOREIGN KEY (product_id)
      REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- 8. B·∫£ng chi ti·∫øt ƒë∆°n h√†ng
CREATE TABLE order_items (
  id INT NOT NULL AUTO_INCREMENT,
  order_id INT,
  product_id INT,
  so_luong INT NOT NULL,
  gia_ban DECIMAL(15,2) NOT NULL,
  PRIMARY KEY (id),
  KEY (order_id),
  KEY (product_id),
  CONSTRAINT fk_order_item_order FOREIGN KEY (order_id)
      REFERENCES orders(id) ON DELETE CASCADE,
  CONSTRAINT fk_order_item_product FOREIGN KEY (product_id)
      REFERENCES products(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;



-- 10. D·ªØ li·ªáu m·∫´u

INSERT INTO customers VALUES 
(1,'KH001','V≈© Duy Kh√°nh','Ho√†ng Mai, H√† N·ªôi','0911111111','khanh@gmail.com',NOW(),NOW()),
(2,'KH002','Nguy·ªÖn VƒÉn Hi·ªáp','H√† ƒê√¥ng, H√† N·ªôi','0911111112','hiep@yahoo.com',NOW(),NOW()),
(3,'KH003','Nguy·ªÖn VƒÉn H·∫£i','H√† ƒê√¥ng, H√† N·ªôi','0911111113','hai@gmail.com',NOW(),NOW()),
(4,'KH004','L√™ Vi·∫øt Kh√°nh','Ch∆∞∆°ng Mƒ©, H√† N·ªôi','0911111114','vkhanh@gmail.com',NOW(),NOW());

INSERT INTO products VALUES 
(1,'1','Tr√†',10000,'V·ªâ',15,NOW()),
(2,'2','S·ªØa',10000,'H·ªôp',15,NOW()),
(3,'3','Thu·ªëc',8000,'V·ªâ',15,NOW());

INSERT INTO import_batches VALUES
(1,'PN202512021724','2025-12-02','kh√°nh',0,NULL,NOW()),
(2,'PN202512022225','2025-12-02','kh√°nh',0,NULL,NOW()),
(3,'PN202512022250','2025-12-02','kh√°nh',0,NULL,NOW());

-- Fix: gi√° nh·∫≠p s·∫£n ph·∫©m s·ªë 3 kh√¥ng th·ªÉ = 0
INSERT INTO import_items VALUES
(1,1,1,15,5000),
(2,2,2,15,7000),
(3,3,3,15,6000);

INSERT INTO orders VALUES
(1,'DH202512070001',1,150000,'2025-12-07 10:00:00','Ch·ªù giao'),
(2,'DH202512070002',2,200000,'2025-12-07 11:00:00','ƒê√£ giao');

INSERT INTO order_items VALUES
(1,1,1,5,10000),
(2,1,2,10,10000),
(3,2,3,25,8000);


CREATE TABLE users (
  id INT NOT NULL AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL,
  fullname VARCHAR(100),
  email VARCHAR(100),
  password VARCHAR(255) NOT NULL,   -- üî• ƒë·ªïi password_hash ‚Üí password
  role ENUM('admin','staff') DEFAULT 'staff',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

INSERT INTO users (username, fullname, email, password, role) VALUES
('admin', 'Qu·∫£n tr·ªã vi√™n', 'admin@example.com', '123456', 'admin'),
('staff1', 'Nh√¢n vi√™n b√°n h√†ng 1', 'staff1@example.com', '123456', 'staff');





-- 11. B·∫≠t l·∫°i ki·ªÉm tra kh√≥a ngo·∫°i
SET FOREIGN_KEY_CHECKS = 1;
